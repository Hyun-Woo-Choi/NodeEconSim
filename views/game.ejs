<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" type="text/css">
  <link rel="stylesheet" href="stylesheets/theme.css" type="text/css">
  <style>
    html,body {height:100%; margin:0; padding:0;}
    td {padding: 0; margin: 0;}
    .signout_cursor:hover {cursor:pointer;}
  </style>
  <title><%= __('title') %></title>
</head>

<body style="display: flex; flex-direction: column;">
  <div style="flex-grow: 1">
    <!-- ko / en -->
    <nav class="navbar navbar-expand-md navbar-light border-bottom border-gray bg-light" >
      <div class="container">
        <a class="navbar-brand" href="/"><img class="img-fluid" src="images/title_water_re.png" style="width:100px";></a>
        <button class="navbar-toggler navbar-toggler-right" type="button" data-toggle="collapse" data-target="#navbarLightSupportedContent" aria-controls="navbar2SupportedContent" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span> </button>
        <div class="collapse navbar-collapse text-center justify-content-end" id="navbarLightSupportedContent">
          <ul class="navbar-nav">
            <li class="nav-item mx-1">
              <% if (cookie_lang === 'ko') { %>
                <a class="nav-link nav_pointer" style="font-weight: bold;"><u>ko</u></a>
              <% } else { %>
                <a class="nav-link nav_pointer" href="/game/ko">ko</a>
              <% } %>
            </li>
            <li class="nav-item mx-1">
              <% if (cookie_lang === 'en') { %>
                <a class="nav-link nav_pointer" style="font-weight: bold;"><u>en</u></a>
              <% } else { %>
                <a class="nav-link nav_pointer" href="/game/en">en</a>
              <% } %>
            </li>
          </ul>
        </div>
      </div>
    </nav>
    
    <div class="py-5" >
      <div class="container">
        <div class="row">
          <!-- 왼쪽 위 -->
          <div class="col-md-6">
            <a class="text-muted signout_cursor" id="signout" style="font-size: 20px;"><%= __('admin_logout') %></a>
            <% if (now_round < 8) { %> <!-- 커뮤니티 프로젝트 이전 -->
              <h2><%= now_user_id %> / round: <%= now_round %></h2>
            <% } else if (now_round == 8) { %> <!-- 커뮤니티 프로젝트 -->
              <h2><%= now_user_id %> / <%= __('game_user_contribution') %></h2>
            <% } else if (8 < now_round && now_round < 16) { %> <!-- 커뮤니티 프로젝트 이후, -1 == 커뮤니티 프로젝트 -->
              <h2><%= now_user_id %> / round: <%= now_round-1 %></h2>
            <% } else { %> <!-- 게임 종료 -->
              <h2><%= now_user_id %> / <%= __('game_user_gameEnd') %></h2>
            <% } %>
            <hr>
            <div class="container border border-info rounded">
              <% if (now_round == 8) { %> <!-- 커뮤니티 프로젝트 -->
              <div class="list-group list-group-flush" >
                <a class="list-group-item"><%= __('game_user_budget') %> <%= budget %></a>
                <a class="list-group-item"><%= __('game_user_budget_limit') %> <%= budget_limit %></a>
                <% if (game_type == 1) { %> <!-- 게임 유형 1, 전기 값이 변함 -->
                <a class="list-group-item"><%= __('game_user_new_w') %> <%= game_parameters['contri_var'] %> <%= __('game_user_new_w2') %></a>
                <% } else { %> <!-- 게임 유형 2, 전기 값이 불변, 공동 기금 있음 -->
                <a class="list-group-item"><%- __('game_user_value_project') %> <%= game_parameters['contri_var'] %> <%= __('game_user_value_project2') %></a>
                <% } %>
                <a class="list-group-item"><%= __('game_user_largest_budget') %> <%= largest_budget %></a>
                <a class="list-group-item"><%= __('game_user_smallest_budget') %> <%= smallest_budget %></a>
              </div>
              <% } else if (now_round >= 16) { %> <!-- 게임 종료 -->
              <div class="list-group list-group-flush" >
                <a class="list-group-item"><%= __('game_end_finalW') %> <%= game_parameters['init_w'] %></a>
                <a class="list-group-item"><%= __('game_end_totalBudget') %> <%= budget %></a>
              </div>
              <% } else { %> <!-- 파라미터 리스트 -->
              <div class="list-group list-group-flush" >
                <a class="list-group-item"><%= __('game_user_parameter') %> <%= game_parameters['init_w'] %></a>
                <a class="list-group-item"><%= __('game_user_makeCost') %> <%= game_parameters['beef_w'] %> <%= __('game_user_makeCost2') %> <%= game_parameters['chicken_w'] %> <%= __('game_user_makeCost3') %> <%= game_parameters['loan'] %> </a>
                <a class="list-group-item"><%= beef_price %></a>
                <a class="list-group-item"><%= chicekn_price %></a>
              </div>
              <% } %>
            </div>
          </div>
          
          <!-- 오른쪽 위 -->
          <div class="col-md-6">
            <% if (is_wait === 0 && now_round < 16) { %> <!-- 다른 유저를 기다리지도 않고 게임이 종료 되기 이전임 -->
              <div class="row mx-auto">
              <% if (user_status === 4) { %> <!-- 관리자의 게임 멈춤 -->
                <p class="text-monospace my-3 mx-2" id="game_explain"><%= __('game_stop_explanation') %></p>
              <% } else { %>
                <% if (now_round == 8) { %> <!-- 커뮤니티 프로젝트 설명 -->
                <p class="text-monospace my-3 mx-2" id="game_explain"><%- __('game_contribution_explanation') %></p>
                <% } else { %> <!-- 일반 게임 설명 -->
                <p class="text-monospace my-3 mx-2" id="game_explain"><%- __('game_explanation') %></p>
                <% } %>
              <% } %>
              </div>
              <form method="post" action="/game/submit_round">
                <% if (now_round != 8) { %> <!-- 일반 게임 인풋 -->
                <div class="form-group row"> <label for="input_one" class="col-2 col-form-label ml-auto"><%= __('game_beef_input') %></label>
                  <div class="col-6">
                    <input type="text" class="form-control" id="input_one" placeholder="0" name="input_one" required="true"> </div>
                </div>
                <div class="form-group row"> <label for="input_two" class="col-2 col-form-label ml-auto"><%= __('game_chicken_input') %></label>
                  <div class="col-6">
                    <input type="text" class="form-control" id="input_two" placeholder="0" name="input_two" required="true"> </div>
                </div>
                <% } else { %> <!-- 커뮤니티 프로젝트 인풋 -->
                <div class="form-group row"> <label for="input_one" class="col-2 col-form-label ml-auto"><%= __('game_contribution_input') %></label>
                  <div class="col-6">
                    <input type="text" class="form-control" id="input_one" placeholder="0" name="input_one" required="true"> </div>
                </div>
                <input type="hidden" name="input_two" value="0">
                <% } %>
                <input type="hidden" name="round" value="<%= now_round %>">
                <input type="hidden" name="room_number" value="<%= user_room %>">
                <input type="hidden" name="budget" value="<%= budget %>">
                <div class="row">
                  <div class="col-8 ml-auto">
                    <div style="float: right;">
                      <% if (user_status === 3) { %> <!-- 일반 게임 버튼 -->
                        <span class="mr-3"><a id="time_limit"></a></span>
                        <button type="submit" class="btn btn-primary" id="game_submit">Submit</button>
                      <% } else { %> <!-- 관리자의 게임 멈춤 -->
                        <span class="mr-3"><a id="time_limit" style="display: none;"></a></span>
                        <button type="submit" class="btn btn-primary" id="game_submit" disabled>Submit</button>
                      <% } %>
                    </div>
                  </div>
                  <div class="col-8 ml-auto">
                    <span class="mr-3"><a id="game_input_status"><%= game_input_status %></a></span>
                  </div>
                </div>
              </form>
            <% } else if (is_wait === 1) { %> <!-- 다른 유저를 기다림 -->
              <% if (user_status === 4) { %> <!-- 관리자의 게임 멈춤 -->
              <p class="text-monospace my-3 mx-2" id="game_explain"><%= __('game_stop_explanation') %></p>
              <% } else { %> <!-- 기다림 설명 -->
              <p class="text-monospace my-3 mx-2" id="game_explain"><%- __('game_submit_wait') %></p>
              <% } %>
            <% } else if (now_round >= 16) { %> <!-- 게임 종료 -->
              <p class="text-monospace my-3 mx-2" ><%- __('game_end_description') %></p>
            <% } %>
          </div>

          <!-- 왼쪽 아래 다른 사용자 상태 테이블 -->
          <div class="col-md-6 mt-5">
            <div class="table-responsive" style="white-space:nowrap; width:75%;">
              <% if (now_round < 16) { %>
              <table class="table table-sm">
                <thead>
                  <tr>
                    <th>#</th>
                    <th><%= __('game_other_user') %></th>
                    <th><%= __('game_other_status') %></th>
                  </tr>
                </thead>
                <tbody>
                  <%- other_user_status_html %>
                </tbody>
              </table>
              <% } %>
            </div>
          </div>

          <!-- 사용자 기록 테이블 -->
          <div class="col-md-6 mt-5">
            <div class="table-responsive">
              <table class="table table-bordered table-sm" >
                <%- game_record_html %>
              </table>
            </div>
          </div>

        </div>
      </div>
    </div>
    
  </div>
  <footer class="pt-2 border-top border-gray bg-light">
    <div class="container">
      <div class="row">
        <div class="col-md-12 text-center">
          <p>© 2020 Cournot. All rights reserved</p>
        </div>
      </div>
    </div>
  </footer>
  <script src="https://code.jquery.com/jquery-3.4.1.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>
  <script src="/socket.io/socket.io.js"></script>
  <script type="text/javascript" src="javascripts/game_socket.js"></script>
  <script>
    $(function() {
      users_socket.connect_user('<%= now_user_id %>');

      $('#signout').click( function() {
        if ('<%= cookie_lang %>' == 'ko')
          var yes_or_no = confirm('로그아웃 하시겠습니까?');
        else
          var yes_or_no = confirm('Are you sure you want to log out?');
        if (yes_or_no)
          location.replace('/users/signout');
      });
      
      // 입력 제한 시간
      var tDate = '<%= remain_time %>';
      function sessionChkN() {
        if (tDate <= 0) {
          clearTimeout(check_cnt);
          tDate = 0;
        }
        var strTime = Math.floor(tDate / 60) + ":" + add_zeros(tDate % 60, 2);
        $("#time_limit").text(strTime);

        if (tDate < 60) {
          $('#time_limit').css('color', 'red');
        }
        --tDate;
      }

      function add_zeros (num, digit) {
        var zero = '';
        num = num.toString();
        if (num.length < digit) {
            for (var i = 0 ; i < digit - num.length ; ++i) {
                zero += '0';
            }
        }
        return zero + num;
      };
      
      var check_cnt = setInterval(function(){
        sessionChkN();
      }, 1000);

    });
    </script>
</body>

</html>